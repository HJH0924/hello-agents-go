# ä¹ é¢˜4ï¼šPlan-and-Solve åˆ†æ

## é—®é¢˜

`Plan-and-Solve` èŒƒå¼å°†ä»»åŠ¡åˆ†è§£ä¸º"è§„åˆ’"å’Œ"æ‰§è¡Œ"ä¸¤ä¸ªé˜¶æ®µã€‚è¯·æ·±å…¥åˆ†æï¼š

1. åœ¨4.3èŠ‚çš„å®ç°ä¸­ï¼Œè§„åˆ’é˜¶æ®µç”Ÿæˆçš„è®¡åˆ’æ˜¯"é™æ€"çš„ï¼ˆä¸€æ¬¡æ€§ç”Ÿæˆï¼Œä¸å¯ä¿®æ”¹ï¼‰ã€‚å¦‚æœåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç°æŸä¸ªæ­¥éª¤æ— æ³•å®Œæˆæˆ–ç»“æœä¸ç¬¦åˆé¢„æœŸï¼Œåº”è¯¥å¦‚ä½•è®¾è®¡ä¸€ä¸ª"åŠ¨æ€é‡è§„åˆ’"æœºåˆ¶ï¼Ÿ
2. å¯¹æ¯” `Plan-and-Solve` ä¸ `ReAct`ï¼šåœ¨å¤„ç†"é¢„è®¢ä¸€æ¬¡ä»åŒ—äº¬åˆ°ä¸Šæµ·çš„å•†åŠ¡æ—…è¡Œï¼ˆåŒ…æ‹¬æœºç¥¨ã€é…’åº—ã€ç§Ÿè½¦ï¼‰"è¿™æ ·çš„ä»»åŠ¡æ—¶ï¼Œå“ªç§èŒƒå¼æ›´åˆé€‚ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ
3. å°è¯•è®¾è®¡ä¸€ä¸ª"åˆ†å±‚è§„åˆ’"ç³»ç»Ÿï¼šå…ˆç”Ÿæˆé«˜å±‚æ¬¡çš„æŠ½è±¡è®¡åˆ’ï¼Œç„¶åé’ˆå¯¹æ¯ä¸ªé«˜å±‚æ­¥éª¤å†ç”Ÿæˆè¯¦ç»†çš„å­è®¡åˆ’ã€‚è¿™ç§è®¾è®¡æœ‰ä»€ä¹ˆä¼˜åŠ¿ï¼Ÿ

---

## å›ç­”

### 1. åŠ¨æ€é‡è§„åˆ’æœºåˆ¶è®¾è®¡

#### æ ¸å¿ƒæ€è·¯

åœ¨Plan-and-Solveçš„æ‰§è¡Œé˜¶æ®µåŠ å…¥"æ£€æŸ¥ç‚¹"æœºåˆ¶ï¼Œå½“å‘ç°é—®é¢˜æ—¶è§¦å‘é‡è§„åˆ’ã€‚

#### æ¶æ„è®¾è®¡

```
æ‰§è¡Œæµç¨‹ï¼š
Plan â†’ Execute Step 1 â†’ Check â†’ Pass â†’ Execute Step 2 â†’ Check â†’ Fail â†’ Replan â†’ Continue
```

#### Go å®ç°æ¡†æ¶

```go
type DynamicPlanAndSolveAgent struct {
    planner  *Planner
    executor *Executor
    checker  *ExecutionChecker  // æ–°å¢ï¼šæ‰§è¡Œæ£€æŸ¥å™¨
}

// ExecutionChecker æ£€æŸ¥æ‰§è¡Œç»“æœæ˜¯å¦ç¬¦åˆé¢„æœŸ
type ExecutionChecker struct {
    llmClient *HelloAgentsLLM
}

func (c *ExecutionChecker) Check(ctx context.Context, step string, result string, originalQuestion string) (bool, string, error) {
    prompt := fmt.Sprintf(`
ä½ æ˜¯ä¸€ä¸ªæ‰§è¡Œæ£€æŸ¥ä¸“å®¶ã€‚è¯·åˆ¤æ–­ä»¥ä¸‹æ­¥éª¤çš„æ‰§è¡Œç»“æœæ˜¯å¦ç¬¦åˆé¢„æœŸï¼š

åŸå§‹é—®é¢˜ï¼š%s
å½“å‰æ­¥éª¤ï¼š%s
æ‰§è¡Œç»“æœï¼š%s

è¯·å›ç­”ï¼š
1. ç»“æœæ˜¯å¦ç¬¦åˆé¢„æœŸï¼Ÿ(æ˜¯/å¦)
2. å¦‚æœä¸ç¬¦åˆï¼Œé—®é¢˜æ˜¯ä»€ä¹ˆï¼Ÿ
3. æ˜¯å¦éœ€è¦é‡æ–°è§„åˆ’ï¼Ÿ

æ ¼å¼ï¼š
{
  "is_valid": true/false,
  "issue": "é—®é¢˜æè¿°",
  "need_replan": true/false
}
`, originalQuestion, step, result)

    // è°ƒç”¨LLMæ£€æŸ¥
    response, err := c.llmClient.Think(ctx, []openai.ChatCompletionMessage{
        {Role: openai.ChatMessageRoleUser, Content: prompt},
    }, 0.3)

    // è§£æå“åº”
    // ...
}

// Run å¸¦åŠ¨æ€é‡è§„åˆ’çš„æ‰§è¡Œ
func (a *DynamicPlanAndSolveAgent) Run(ctx context.Context, question string) (string, error) {
    // 1. åˆå§‹è§„åˆ’
    plan, err := a.planner.Plan(ctx, question)
    if err != nil {
        return "", err
    }

    // 2. æ‰§è¡Œ + æ£€æŸ¥ + é‡è§„åˆ’å¾ªç¯
    completedSteps := []string{}
    currentPlan := plan

    for i := 0; i < len(currentPlan); i++ {
        step := currentPlan[i]
        result, err := a.executor.ExecuteStep(ctx, question, step, completedSteps)
        
        // æ£€æŸ¥æ‰§è¡Œç»“æœ
        isValid, issue, needReplan, err := a.checker.Check(ctx, step, result, question)
        
        if !isValid && needReplan {
            fmt.Printf("âš ï¸ æ­¥éª¤æ‰§è¡Œå¼‚å¸¸ï¼š%s\n", issue)
            fmt.Println("ğŸ”„ è§¦å‘é‡æ–°è§„åˆ’...")
            
            // é‡æ–°è§„åˆ’å‰©ä½™æ­¥éª¤
            remainingTask := fmt.Sprintf("ç»§ç»­å®Œæˆä»»åŠ¡ã€‚å·²å®Œæˆï¼š%vã€‚é‡åˆ°é—®é¢˜ï¼š%s", completedSteps, issue)
            newPlan, err := a.planner.Plan(ctx, remainingTask)
            if err != nil {
                return "", err
            }
            
            currentPlan = append(completedSteps, newPlan...)
            i = len(completedSteps) - 1  // ä»å·²å®Œæˆçš„ä¸‹ä¸€æ­¥ç»§ç»­
            continue
        }
        
        completedSteps = append(completedSteps, result)
    }

    return completedSteps[len(completedSteps)-1], nil
}
```

#### è§¦å‘é‡è§„åˆ’çš„æ¡ä»¶

1. **æ‰§è¡Œå¤±è´¥**ï¼šå·¥å…·è°ƒç”¨è¿”å›é”™è¯¯
2. **ç»“æœä¸ç¬¦åˆé¢„æœŸ**ï¼šLLMåˆ¤æ–­ç»“æœè´¨é‡ä½
3. **ä¾èµ–æ¡ä»¶å˜åŒ–**ï¼šå‰æå‡è®¾ä¸å†æˆç«‹
4. **è¶…æ—¶æˆ–èµ„æºä¸è¶³**

#### ä¼˜åŠ¿

- **å®¹é”™æ€§å¼º**ï¼šèƒ½å¤Ÿåº”å¯¹æ‰§è¡Œä¸­çš„æ„å¤–æƒ…å†µ
- **è‡ªé€‚åº”**ï¼šæ ¹æ®å®é™…æƒ…å†µè°ƒæ•´è®¡åˆ’
- **é¿å…å…¨ç›˜é‡æ¥**ï¼šåªé‡è§„åˆ’å‰©ä½™éƒ¨åˆ†

---

### 2. Plan-and-Solve vs ReActï¼šå•†åŠ¡æ—…è¡Œé¢„è®¢åœºæ™¯

#### ä»»åŠ¡åˆ†æ

**ä»»åŠ¡**ï¼š"é¢„è®¢ä¸€æ¬¡ä»åŒ—äº¬åˆ°ä¸Šæµ·çš„å•†åŠ¡æ—…è¡Œï¼ˆåŒ…æ‹¬æœºç¥¨ã€é…’åº—ã€ç§Ÿè½¦ï¼‰"

**ä»»åŠ¡ç‰¹ç‚¹**ï¼š
- å¤šä¸ªå­ä»»åŠ¡ï¼ˆæœºç¥¨ã€é…’åº—ã€ç§Ÿè½¦ï¼‰
- æ˜ç¡®çš„é€»è¾‘é¡ºåº
- å­ä»»åŠ¡ä¹‹é—´æœ‰ä¾èµ–ï¼ˆå¦‚ï¼šåˆ°è¾¾æ—¶é—´å½±å“ç§Ÿè½¦æ—¶é—´ï¼‰
- éœ€è¦è€ƒè™‘æ—¶é—´ã€é¢„ç®—ç­‰çº¦æŸ

#### Plan-and-Solve æ–¹æ¡ˆ

**è§„åˆ’é˜¶æ®µ**ï¼š
```
Plan = [
    "æ­¥éª¤1ï¼šæŸ¥è¯¢åŒ—äº¬åˆ°ä¸Šæµ·çš„èˆªç­ï¼Œé€‰æ‹©åˆé€‚æ—¶é—´å’Œä»·æ ¼çš„èˆªç­",
    "æ­¥éª¤2ï¼šæ ¹æ®èˆªç­åˆ°è¾¾æ—¶é—´ï¼Œé¢„è®¢ä¸Šæµ·çš„é…’åº—ï¼ˆé è¿‘ä¼šè®®åœ°ç‚¹ï¼‰",
    "æ­¥éª¤3ï¼šé¢„è®¢ç§Ÿè½¦æœåŠ¡ï¼Œå–è½¦æ—¶é—´ä¸ºèˆªç­åˆ°è¾¾å1å°æ—¶",
    "æ­¥éª¤4ï¼šç¡®è®¤æ‰€æœ‰é¢„è®¢å¹¶ç”Ÿæˆè¡Œç¨‹å•"
]
```

**æ‰§è¡Œé˜¶æ®µ**ï¼šä¸¥æ ¼æŒ‰ç…§è®¡åˆ’æ‰§è¡Œ

**ä¼˜ç‚¹**ï¼š
- âœ… ç»“æ„æ¸…æ™°ï¼šæ‰€æœ‰æ­¥éª¤ä¸€ç›®äº†ç„¶
- âœ… é¿å…é—æ¼ï¼šæå‰è§„åˆ’å¥½æ‰€æœ‰ç¯èŠ‚
- âœ… æ—¶é—´ä¼°ç®—å‡†ç¡®ï¼šå¯ä»¥é¢„ä¼°æ€»è€—æ—¶
- âœ… èµ„æºè§„åˆ’ï¼šå¯ä»¥ä¼˜åŒ–é¢„ç®—åˆ†é…

**ç¼ºç‚¹**ï¼š
- âŒ ä¸å¤Ÿçµæ´»ï¼šå¦‚æœé¦–é€‰èˆªç­æ²¡ç¥¨ï¼Œè®¡åˆ’å—å½±å“
- âŒ é™æ€çº¦æŸï¼šæ— æ³•åŠ¨æ€è°ƒæ•´ï¼ˆå¦‚å‘ç°æ›´ä¾¿å®œçš„ç»„åˆï¼‰

#### ReAct æ–¹æ¡ˆ

**æ‰§è¡Œè¿‡ç¨‹**ï¼š
```
Thought: éœ€è¦é¢„è®¢èˆªç­ï¼Œå…ˆæœç´¢å¯ç”¨èˆªç­
Action: SearchFlight[åŒ—äº¬-ä¸Šæµ·, æ˜å¤©]
Observation: æ‰¾åˆ°3ä¸ªèˆªç­ï¼ŒMU5178æœ€ä¾¿å®œ

Thought: MU5178æ€§ä»·æ¯”é«˜ï¼Œé¢„è®¢å®ƒ
Action: BookFlight[MU5178]
Observation: é¢„è®¢æˆåŠŸï¼Œåˆ°è¾¾æ—¶é—´14:00

Thought: æ ¹æ®åˆ°è¾¾æ—¶é—´14:00ï¼Œé¢„è®¢é™„è¿‘é…’åº—
Action: SearchHotel[ä¸Šæµ·, 14:00å…¥ä½]
...
```

**ä¼˜ç‚¹**ï¼š
- âœ… é«˜åº¦çµæ´»ï¼šæ ¹æ®å®æ—¶åé¦ˆè°ƒæ•´
- âœ… åŠ¨æ€ä¼˜åŒ–ï¼šå‘ç°æ›´å¥½é€‰æ‹©å¯ä»¥è°ƒæ•´
- âœ… å¤„ç†å¼‚å¸¸ï¼šèˆªç­æ²¡ç¥¨ç«‹å³åˆ‡æ¢å¤‡é€‰

**ç¼ºç‚¹**ï¼š
- âŒ å¯èƒ½é—æ¼ï¼šæ²¡æœ‰å…¨å±€è§†é‡ï¼Œå¯èƒ½å¿˜è®°ç§Ÿè½¦
- âŒ ç¼ºä¹ä¼˜åŒ–ï¼šæ­¥è¿›å†³ç­–å¯èƒ½é”™å¤±æ•´ä½“æœ€ä¼˜æ–¹æ¡ˆ
- âŒ æˆæœ¬é«˜ï¼šéœ€è¦å¤šæ¬¡LLMè°ƒç”¨

#### æ¨èæ–¹æ¡ˆ

**ç»“è®º**ï¼šæ¨èä½¿ç”¨ **Plan-and-Solve**

**ç†ç”±**ï¼š

1. **ä»»åŠ¡ç»“æ„æ˜ç¡®**
   - å•†åŠ¡æ—…è¡Œé¢„è®¢æ˜¯å…¸å‹çš„ç»“æ„åŒ–ä»»åŠ¡
   - æ­¥éª¤æ¸…æ™°ï¼šæœºç¥¨ â†’ é…’åº— â†’ ç§Ÿè½¦
   - Plan-and-Solveçš„ä¼˜åŠ¿å¾—ä»¥å……åˆ†å‘æŒ¥

2. **å…¨å±€ä¼˜åŒ–éœ€æ±‚**
   - éœ€è¦è€ƒè™‘æ•´ä½“é¢„ç®—
   - éœ€è¦åè°ƒå„ç¯èŠ‚æ—¶é—´
   - è§„åˆ’é˜¶æ®µå¯ä»¥è¿›è¡Œæ•´ä½“ä¼˜åŒ–

3. **å‡å°‘å†³ç­–æˆæœ¬**
   - ä¸€æ¬¡æ€§è§„åˆ’å¥½ï¼Œæ‰§è¡Œæ•ˆç‡é«˜
   - å‡å°‘LLMè°ƒç”¨æ¬¡æ•°
   - ç”¨æˆ·ä½“éªŒæ›´å¥½ï¼ˆä¸ç”¨ç­‰å¾…å¤šæ¬¡å†³ç­–ï¼‰

4. **å¯é¢„æµ‹æ€§**
   - ç”¨æˆ·åœ¨æ‰§è¡Œå‰å°±èƒ½çœ‹åˆ°å®Œæ•´è®¡åˆ’
   - æ›´ç¬¦åˆå•†åŠ¡åœºæ™¯çš„éœ€æ±‚

**æ”¹è¿›å»ºè®®**ï¼š
- ç»“åˆåŠ¨æ€é‡è§„åˆ’æœºåˆ¶ï¼Œå¤„ç†é¢„è®¢å¤±è´¥ç­‰æ„å¤–
- åœ¨è§„åˆ’é˜¶æ®µè€ƒè™‘å¤‡é€‰æ–¹æ¡ˆ

---

### 3. åˆ†å±‚è§„åˆ’ç³»ç»Ÿè®¾è®¡

#### æ ¸å¿ƒæ€æƒ³

```
é«˜å±‚æŠ½è±¡è®¡åˆ’ï¼ˆWhatï¼‰
    â†“
è¯¦ç»†æ‰§è¡Œè®¡åˆ’ï¼ˆHowï¼‰
```

#### æ¶æ„è®¾è®¡

```go
type HierarchicalPlanner struct {
    highLevelPlanner *Planner  // é«˜å±‚è§„åˆ’å™¨
    lowLevelPlanner  *Planner  // ä½å±‚è§„åˆ’å™¨
}

type HierarchicalPlan struct {
    HighLevel []HighLevelStep
}

type HighLevelStep struct {
    Goal      string        // é«˜å±‚ç›®æ ‡
    SubPlan   []string      // è¯¦ç»†å­æ­¥éª¤
}

func (p *HierarchicalPlanner) Plan(ctx context.Context, question string) (*HierarchicalPlan, error) {
    // 1. ç”Ÿæˆé«˜å±‚è®¡åˆ’
    highLevelSteps, err := p.highLevelPlanner.Plan(ctx, question)
    if err != nil {
        return nil, err
    }

    // 2. ä¸ºæ¯ä¸ªé«˜å±‚æ­¥éª¤ç”Ÿæˆè¯¦ç»†è®¡åˆ’
    var plan HierarchicalPlan
    for _, highStep := range highLevelSteps {
        subPlan, err := p.lowLevelPlanner.Plan(ctx, highStep)
        if err != nil {
            return nil, err
        }

        plan.HighLevel = append(plan.HighLevel, HighLevelStep{
            Goal:    highStep,
            SubPlan: subPlan,
        })
    }

    return &plan, nil
}
```

#### ç¤ºä¾‹ï¼šç”µå•†ç³»ç»Ÿå¼€å‘

**é«˜å±‚è®¡åˆ’**ï¼š
```
[
    "éœ€æ±‚åˆ†æå’Œæ¶æ„è®¾è®¡",
    "æ•°æ®åº“è®¾è®¡å’Œå®ç°",
    "åç«¯APIå¼€å‘",
    "å‰ç«¯ç•Œé¢å¼€å‘",
    "æµ‹è¯•å’Œéƒ¨ç½²"
]
```

**è¯¦ç»†å­è®¡åˆ’ï¼ˆä»¥"åç«¯APIå¼€å‘"ä¸ºä¾‹ï¼‰**ï¼š
```
[
    "è®¾è®¡RESTful APIæ¥å£è§„èŒƒ",
    "å®ç°ç”¨æˆ·è®¤è¯å’Œæˆæƒæ¨¡å—",
    "å®ç°å•†å“ç®¡ç†API",
    "å®ç°è®¢å•å¤„ç†API",
    "å®ç°æ”¯ä»˜é›†æˆ",
    "ç¼–å†™APIæ–‡æ¡£"
]
```

#### ä¼˜åŠ¿

1. **æ›´å¥½çš„ä»»åŠ¡åˆ†è§£**
   - é«˜å±‚ï¼šå…³æ³¨ç›®æ ‡å’Œé‡Œç¨‹ç¢‘
   - ä½å±‚ï¼šå…³æ³¨å…·ä½“å®ç°æ­¥éª¤
   - é¿å…ç»†èŠ‚æ·¹æ²¡å…¨å±€

2. **çµæ´»æ€§**
   - é«˜å±‚è®¡åˆ’ç›¸å¯¹ç¨³å®š
   - ä½å±‚è®¡åˆ’å¯ä»¥çµæ´»è°ƒæ•´
   - æŸä¸ªæ¨¡å—å¤±è´¥ä¸å½±å“æ•´ä½“æ¡†æ¶

3. **å¹¶è¡Œæ‰§è¡Œå¯èƒ½**
   - ç‹¬ç«‹çš„é«˜å±‚ç›®æ ‡å¯ä»¥å¹¶è¡Œ
   - ä¾‹å¦‚ï¼šå‰åç«¯å¯ä»¥å¹¶è¡Œå¼€å‘

4. **è¿›åº¦è·Ÿè¸ª**
   - æ¸…æ™°çš„é‡Œç¨‹ç¢‘
   - æ˜“äºè¯„ä¼°å®Œæˆåº¦
   - ä¾¿äºå‘ç”¨æˆ·æŠ¥å‘Šè¿›åº¦

5. **è®¤çŸ¥è´Ÿæ‹…å°**
   - æ¯æ¬¡åªéœ€å…³æ³¨ä¸€ä¸ªå±‚æ¬¡
   - LLMç”Ÿæˆçš„è®¡åˆ’æ›´å‡†ç¡®
   - é¿å…ä¸€æ¬¡è§„åˆ’è¿‡äºåºå¤§

#### å®é™…åº”ç”¨åœºæ™¯

- âœ… è½¯ä»¶å¼€å‘é¡¹ç›®
- âœ… ç§‘ç ”é¡¹ç›®è§„åˆ’
- âœ… å•†ä¸šè®¡åˆ’åˆ¶å®š
- âœ… æ•™è‚²è¯¾ç¨‹è®¾è®¡
- âŒ ç®€å•ä»»åŠ¡ï¼ˆè¿‡åº¦è®¾è®¡ï¼‰

---

## æ€»ç»“

1. **åŠ¨æ€é‡è§„åˆ’**ï¼šåœ¨æ‰§è¡Œé˜¶æ®µåŠ å…¥æ£€æŸ¥ç‚¹ï¼Œå‘ç°é—®é¢˜æ—¶è§¦å‘é‡è§„åˆ’
2. **åœºæ™¯é€‰æ‹©**ï¼šå•†åŠ¡æ—…è¡Œé¢„è®¢é€‚åˆPlan-and-Solveï¼Œå› ä¸ºç»“æ„æ¸…æ™°ã€éœ€è¦å…¨å±€ä¼˜åŒ–
3. **åˆ†å±‚è§„åˆ’**ï¼šé€‚åˆå¤æ‚é¡¹ç›®ï¼Œæä¾›æ›´å¥½çš„ä»»åŠ¡åˆ†è§£å’Œè¿›åº¦è·Ÿè¸ªèƒ½åŠ›

**å…³é”®æ´å¯Ÿ**ï¼š
- Plan-and-Solveçš„é™æ€æ€§å¯ä»¥é€šè¿‡åŠ¨æ€é‡è§„åˆ’å¼¥è¡¥
- é€‰æ‹©èŒƒå¼è¦æ ¹æ®ä»»åŠ¡çš„ç»“æ„æ€§å’Œå¯é¢„æµ‹æ€§
- å¤æ‚ä»»åŠ¡éœ€è¦åˆ†å±‚æ€ç»´ï¼Œé¿å…è®¤çŸ¥è¿‡è½½
