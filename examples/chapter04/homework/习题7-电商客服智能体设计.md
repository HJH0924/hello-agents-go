# 习题7：电商客服智能体设计

## 问题

某电商初创公司现在希望使用"客服智能体"来代替真人客服实现降本增效，它需要具备以下功能：

a. 理解用户的退款申请理由
b. 查询用户的订单信息和物流状态
c. 根据公司政策智能地判断是否应该批准退款
d. 生成一封得体的回复邮件并发送至用户邮箱
e. 如果判断决策存在一定争议（自我置信度低于阈值），能够进行自我反思并给出更审慎的建议

此时作为该产品的负责人：
- 你会选择本章的哪种范式（或哪些范式的组合）作为系统的核心架构？
- 这个系统需要哪些工具？请列出至少3个工具及其功能描述。
- 如何设计提示词来确保智能体的决策既符合公司利益，又能保持对用户的友好态度？
- 这个产品上线后可能面临哪些风险和挑战？如何通过技术手段来降低这些风险？

---

## 系统设计方案

### 1. 架构选择：ReAct + Reflection 混合模式

#### 选择理由

**ReAct 部分**（处理信息收集和决策）：
- 需要动态查询订单、物流信息
- 需要根据查询结果调整判断逻辑
- 符合ReAct的探索式特点

**Reflection 部分**（处理争议案例）：
- 低置信度决策需要反思
- 确保决策质量和合规性
- 避免误判损害用户体验或公司利益

#### 架构图

```
用户退款申请
    ↓
┌─────────────────────────────────┐
│  ReAct 执行器                   │
│  - 理解申请理由                 │
│  - 查询订单信息                 │
│  - 查询物流状态                 │
│  - 检查退款政策                 │
│  - 初步决策（批准/拒绝）        │
└─────────────┬───────────────────┘
              ↓
      ┌──────────────┐
      │ 置信度检查   │
      └─┬──────────┬─┘
        │          │
    高置信度    低置信度
        │          │
        ↓          ↓
   直接执行  ┌──────────────┐
            │ Reflection   │
            │ - 重新评估   │
            │ - 考虑边界   │
            │ - 风险分析   │
            └──────────────┘
                  ↓
          生成回复并发送
```

### 2. 工具设计

#### 工具列表

```go
// 1. 订单查询工具
type OrderQueryTool struct {}

func (t *OrderQueryTool) Query(orderID string) (*OrderInfo, error) {
    // 查询订单详情：
    // - 订单金额
    // - 购买时间
    // - 商品信息
    // - 订单状态
    return orderInfo, nil
}

// 2. 物流查询工具
type LogisticsQueryTool struct {}

func (t *LogisticsQueryTool) Query(orderID string) (*LogisticsInfo, error) {
    // 查询物流状态：
    // - 发货时间
    // - 当前位置
    // - 预计到达时间
    // - 签收状态
    return logisticsInfo, nil
}

// 3. 退款政策检查工具
type RefundPolicyChecker struct {}

func (t *RefundPolicyChecker) Check(orderInfo *OrderInfo, reason string) (*PolicyResult, error) {
    // 检查是否符合退款政策：
    // - 是否在退款期限内（如7天无理由退款）
    // - 商品是否支持退款
    // - 退款理由是否合理
    return policyResult, nil
}

// 4. 邮件发送工具
type EmailSenderTool struct {}

func (t *EmailSenderTool) Send(to string, subject string, body string) error {
    // 发送邮件
    return nil
}

// 5. 风险评估工具
type RiskAssessmentTool struct {}

func (t *RiskAssessmentTool) Assess(orderInfo *OrderInfo, userHistory *UserHistory) (*RiskScore, error) {
    // 评估欺诈风险：
    // - 用户历史退款次数
    // - 账户异常行为
    // - 订单金额与用户等级是否匹配
    return riskScore, nil
}
```

### 3. 提示词设计

#### 核心原则

- **双重目标**：保护公司利益 + 维护用户体验
- **透明度**：决策过程可解释
- **同理心**：理解用户立场

#### 主提示词

```
你是一位专业、友好的电商客服智能体。你的职责是处理用户的退款申请。

核心原则：
1. 公平公正：严格遵守公司退款政策，同时充分理解用户诉求
2. 友好专业：保持礼貌和同理心，即使拒绝退款也要给出充分理由
3. 合规透明：所有决策需有明确依据，可向用户解释

决策指导：
- 如果订单符合7天无理由退款政策，应当批准
- 如果商品有质量问题，应当批准并表示歉意
- 如果用户恶意退款（频繁退款、使用后退款），应当拒绝但保持礼貌
- 如果情况存在争议，请进行自我反思并给出审慎建议

可用工具：
- OrderQuery: 查询订单信息
- LogisticsQuery: 查询物流状态
- RefundPolicyCheck: 检查退款政策
- RiskAssessment: 评估风险
- EmailSender: 发送邮件

请按照以下格式回应：
Thought: 你的分析过程
Action: ToolName[input]
Observation: 工具返回结果

当你做出最终决策时：
Action: Finish[决策结果和理由]
```

#### 反思阶段提示词（低置信度触发）

```
你是一位资深的客服主管，正在审查AI客服的退款决策。

原始问题：{question}
AI的决策：{decision}
置信度：{confidence}

请从以下角度重新评估这个决策：
1. 决策是否符合公司政策？
2. 决策是否公平对待用户？
3. 是否存在潜在风险（欺诈/法律）？
4. 决策理由是否充分？
5. 用户体验如何？

如果需要调整决策，请给出建议。如果决策合理，请确认。
```

### 4. 风险与应对

#### 主要风险

| 风险类别 | 具体风险 | 应对措施 |
|---------|---------|---------|
| **误判风险** | - 错误拒绝合理退款<br>- 批准欺诈性退款 | - Reflection机制双重检查<br>- 人工复核争议案例<br>- 持续监控误判率 |
| **合规风险** | - 违反消费者权益保护法<br>- 不符合公司政策 | - 政策库定期更新<br>- 决策可追溯<br>- 法务团队审核 |
| **体验风险** | - 回复不够友好<br>- 处理时间过长 | - 提示词强调同理心<br>- 优化执行效率<br>- 实时反馈机制 |
| **安全风险** | - 数据泄露<br>- 恶意攻击 | - 数据加密<br>- 访问控制<br>- 异常检测 |
| **系统风险** | - API故障<br>- LLM不稳定 | - 降级方案<br>- 人工接管<br>- 多模型备份 |

#### 技术应对方案

```go
// 1. 风险监控系统
type RiskMonitor struct {
    errorRate       float64  // 误判率
    avgConfidence   float64  // 平均置信度
    appealRate      float64  // 申诉率
    fraudDetection  int      // 检测到的欺诈案例
}

// 2. 人工复核队列
type HumanReviewQueue struct {
    cases []Case
}

func (q *HumanReviewQueue) Add(case Case) {
    // 低置信度案例自动进入人工复核
    if case.Confidence < 0.7 {
        q.cases = append(q.cases, case)
    }
}

// 3. 决策可追溯
type DecisionLog struct {
    OrderID    string
    Decision   string
    Reasoning  []string  // 推理过程
    Confidence float64
    Timestamp  time.Time
    Model      string
}

// 4. 降级机制
func (a *CustomerServiceAgent) ProcessRefund(request RefundRequest) error {
    defer func() {
        if r := recover(); r != nil {
            // 系统异常，降级到人工处理
            notifyHumanAgent(request)
        }
    }()

    // 正常处理流程
    return a.run(request)
}
```

#### 持续改进机制

1. **A/B测试**：不同提示词版本对比
2. **反馈循环**：收集用户评价和申诉
3. **案例学习**：从误判案例中学习
4. **定期审计**：合规性和公平性审计

---

## 总结

**核心设计**：
- 架构：ReAct（信息收集）+ Reflection（争议处理）
- 工具：订单查询、物流查询、政策检查、风险评估、邮件发送
- 策略：双重目标（公司利益+用户体验）、透明决策、风险控制

**关键成功因素**：
1. 提示词设计平衡公司和用户立场
2. Reflection机制处理边界案例
3. 完善的风险监控和人工复核
4. 持续优化和学习机制
